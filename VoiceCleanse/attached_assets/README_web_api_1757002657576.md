# ğŸ¯ èªéŸ³åˆ†é›¢ Web API

åŸºæ–¼ä½ çš„Third_200.ptæ¨¡å‹çš„å®Œæ•´Webæœå‹™ï¼Œæ”¯æ´éŸ³é »ä¸Šå‚³ã€è™•ç†å’Œä¸‹è¼‰ï¼Œä¸¦è¨ˆç®—SI-SNRæ”¹å–„ç¨‹åº¦ã€‚

## ğŸš€ å¿«é€Ÿé–‹å§‹

### å¾Œç«¯å•Ÿå‹•

```bash
# æ–¹æ³•1: ä½¿ç”¨å•Ÿå‹•è…³æœ¬ (æ¨è–¦)
python start_backend.py

# æ–¹æ³•2: ç›´æ¥é‹è¡Œ
python flask_backend.py
```

### å‰ç«¯é›†æˆ

å°‡ `frontend_api_code.js` çš„ä»£ç¢¼è¤‡è£½åˆ°ä½ çš„Replité …ç›®ä¸­ä½¿ç”¨ã€‚

## ğŸ“¡ API æ–‡æª”

### 1. å¥åº·æª¢æŸ¥
```
GET /api/health
```
**éŸ¿æ‡‰:**
```json
{
  "status": "ok",
  "model_loaded": true,
  "gpu_available": true,
  "device": "cuda",
  "timestamp": "2024-01-01T12:00:00"
}
```

### 2. ä¸Šå‚³éŸ³é »
```
POST /api/upload
Content-Type: multipart/form-data
```
**åƒæ•¸:**
- `audio_file`: éŸ³é »æ–‡ä»¶ (WAV/MP3/FLAC/OGG/M4A, æœ€å¤§50MB)

**éŸ¿æ‡‰:**
```json
{
  "task_id": "uuid-string",
  "status": "queued",
  "message": "æ–‡ä»¶ä¸Šå‚³æˆåŠŸï¼Œé–‹å§‹è™•ç†...",
  "file_size": 1024000,
  "original_filename": "test.wav"
}
```

### 3. æŸ¥è©¢ç‹€æ…‹
```
GET /api/status/<task_id>
```
**éŸ¿æ‡‰ (è™•ç†ä¸­):**
```json
{
  "task_id": "uuid-string",
  "status": "processing",
  "progress": 75,
  "message": "æ­£åœ¨åŸ·è¡ŒèªéŸ³åˆ†é›¢...",
  "estimated_time": 30,
  "original_filename": "test.wav",
  "file_size": 1024000
}
```

**éŸ¿æ‡‰ (å®Œæˆ):**
```json
{
  "task_id": "uuid-string",
  "status": "completed",
  "progress": 100,
  "message": "è™•ç†å®Œæˆï¼",
  "si_snr_improvement": 8.5,
  "audio_duration": 6.0,
  "processing_time": 0.8,
  "download_url": "/api/download/uuid-string",
  "original_filename": "test.wav"
}
```

### 4. ä¸‹è¼‰çµæœ
```
GET /api/download/<task_id>
```
**éŸ¿æ‡‰:** éŸ³é »æ–‡ä»¶ (WAVæ ¼å¼)

## ğŸ”§ å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

### JavaScript (ç´”å‰ç«¯)
```javascript
const api = new AudioSeparationAPI('http://localhost:5000');

// è™•ç†éŸ³é »æ–‡ä»¶
async function processAudio(audioFile) {
    try {
        // 1. ä¸Šå‚³æ–‡ä»¶
        const uploadResult = await api.uploadAudio(audioFile);
        console.log('ä¸Šå‚³æˆåŠŸ:', uploadResult);

        // 2. è¼ªè©¢ç‹€æ…‹
        api.startPolling(
            uploadResult.task_id,
            // é€²åº¦æ›´æ–°
            (status) => {
                console.log(`é€²åº¦: ${status.progress}% - ${status.message}`);
                updateProgressBar(status.progress);
            },
            // è™•ç†å®Œæˆ
            async (result) => {
                console.log('è™•ç†å®Œæˆ:', result);
                console.log(`SI-SNRæ”¹å–„: ${result.si_snr_improvement}dB`);
                
                // ä¸‹è¼‰çµæœ
                const { blob, filename } = await api.downloadResult(result.task_id);
                api.downloadFile(blob, filename);
            },
            // éŒ¯èª¤è™•ç†
            (error) => {
                console.error('è™•ç†å¤±æ•—:', error);
            }
        );
    } catch (error) {
        console.error('éŒ¯èª¤:', error);
    }
}
```

### React Hook
```javascript
function AudioProcessor() {
    const {
        processAudio,
        downloadResult,
        isProcessing,
        progress,
        status,
        result,
        error
    } = useAudioSeparation('http://localhost:5000');

    const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
            processAudio(file);
        }
    };

    return (
        <div>
            <input type="file" onChange={handleFileUpload} />
            
            {isProcessing && (
                <div>
                    <div>é€²åº¦: {progress}%</div>
                    <div>ç‹€æ…‹: {status}</div>
                </div>
            )}
            
            {result && (
                <div>
                    <h3>è™•ç†å®Œæˆï¼</h3>
                    <p>SI-SNRæ”¹å–„: {result.si_snr_improvement}dB</p>
                    <p>è™•ç†æ™‚é–“: {result.processing_time}ç§’</p>
                    <button onClick={() => downloadResult(result.task_id)}>
                        ä¸‹è¼‰çµæœ
                    </button>
                </div>
            )}
            
            {error && <div style={{color: 'red'}}>éŒ¯èª¤: {error}</div>}
        </div>
    );
}
```

## ğŸ“Š SI-SNR æ”¹å–„æŒ‡æ¨™

APIæœƒè‡ªå‹•è¨ˆç®—ä¸¦è¿”å›SI-SNRæ”¹å–„ç¨‹åº¦ï¼š

- **æ­£å€¼**: è¡¨ç¤ºéŸ³è³ªæ”¹å–„ï¼Œæ•¸å€¼è¶Šå¤§æ•ˆæœè¶Šå¥½
- **è² å€¼**: è¡¨ç¤ºå¯èƒ½éåº¦è™•ç†
- **å…¸å‹ç¯„åœ**: 0-15dB

**è§£é‡‹:**
- `0-3dB`: è¼•å¾®æ”¹å–„
- `3-8dB`: æ˜é¡¯æ”¹å–„  
- `8-15dB`: é¡¯è‘—æ”¹å–„
- `>15dB`: æ¥µä½³æ•ˆæœ

## âš™ï¸ é…ç½®é¸é …

### å¾Œç«¯é…ç½® (flask_backend.py)
```python
# æ–‡ä»¶é…ç½®
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB
ALLOWED_EXTENSIONS = {'wav', 'mp3', 'flac', 'ogg', 'm4a'}

# æ¨¡å‹è·¯å¾‘
MODEL_PATH = "D:/data_output/eval/Third_200.pt"

# æ¸…ç†é…ç½®
UPLOAD_RETENTION = 3600    # ä¸Šå‚³æ–‡ä»¶ä¿ç•™1å°æ™‚
RESULT_RETENTION = 86400   # çµæœæ–‡ä»¶ä¿ç•™24å°æ™‚
```

### å‰ç«¯é…ç½®
```javascript
// APIåŸºç¤URL
const api = new AudioSeparationAPI('http://your-backend-url:5000');

// è¼ªè©¢é–“éš”
const POLLING_INTERVAL = 2000; // 2ç§’
```

## ğŸ”§ éƒ¨ç½²å»ºè­°

### é–‹ç™¼ç’°å¢ƒ
1. æœ¬åœ°é‹è¡Œå¾Œç«¯: `python start_backend.py`
2. ä½¿ç”¨ngrokå…¬é–‹: `ngrok http 5000`
3. åœ¨Replitä¸­ä½¿ç”¨ngrok URL

### ç”Ÿç”¢ç’°å¢ƒ
1. **å¾Œç«¯**: AWS/GCP GPUå¯¦ä¾‹ + Docker
2. **å‰ç«¯**: Vercel/Netlify
3. **åŸŸå**: é…ç½®HTTPSå’ŒCORS

## ğŸš¨ æ³¨æ„äº‹é …

1. **GPUè¨˜æ†¶é«”**: ç¢ºä¿æœ‰è¶³å¤ çš„GPUè¨˜æ†¶é«”
2. **æ–‡ä»¶å¤§å°**: é™åˆ¶ä¸Šå‚³æ–‡ä»¶å¤§å°é¿å…è¶…æ™‚
3. **ä½µç™¼è™•ç†**: ç•¶å‰ç‰ˆæœ¬ä¸æ”¯æ´ä½µç™¼ï¼Œå»ºè­°åŠ å…¥éšŠåˆ—ç³»çµ±
4. **å®‰å…¨æ€§**: ç”Ÿç”¢ç’°å¢ƒéœ€è¦æ·»åŠ èªè­‰å’Œé€Ÿç‡é™åˆ¶

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

**1. æ¨¡å‹è¼‰å…¥å¤±æ•—**
```
âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—: No such file or directory
```
**è§£æ±º**: æª¢æŸ¥ `MODEL_PATH` æ˜¯å¦æ­£ç¢º

**2. CUDAè¨˜æ†¶é«”ä¸è¶³**
```
âŒ CUDA out of memory
```
**è§£æ±º**: é‡å•Ÿå¾Œç«¯æœå‹™æˆ–ä½¿ç”¨CPUæ¨¡å¼

**3. CORSéŒ¯èª¤**
```
Access to fetch at 'http://localhost:5000' from origin 'https://replit.com' has been blocked by CORS
```
**è§£æ±º**: å¾Œç«¯å·²é…ç½®CORSï¼Œæª¢æŸ¥URLæ˜¯å¦æ­£ç¢º

**4. æ–‡ä»¶æ ¼å¼ä¸æ”¯æ´**
```
âŒ ä¸æ”¯æ´çš„æ–‡ä»¶æ ¼å¼
```
**è§£æ±º**: ç¢ºä¿æ–‡ä»¶æ˜¯ WAV/MP3/FLAC/OGG/M4A æ ¼å¼

## ğŸ“ˆ æ€§èƒ½æŒ‡æ¨™

- **å†·å•Ÿå‹•æ™‚é–“**: ~19ç§’ (é¦–æ¬¡è¼‰å…¥æ¨¡å‹)
- **ç†±è™•ç†æ™‚é–“**: ~7ms (æ¨¡å‹å·²è¼‰å…¥)
- **å¯¦æ™‚å€æ•¸**: 100-1000x (å–æ±ºæ–¼éŸ³é »é•·åº¦)
- **è¨˜æ†¶é«”ä½¿ç”¨**: ~4GB GPUè¨˜æ†¶é«”

## ğŸ”„ æ›´æ–°æ—¥èªŒ

- **v1.0**: åŸºæœ¬åŠŸèƒ½ (ä¸Šå‚³/è™•ç†/ä¸‹è¼‰)
- **v1.1**: æ·»åŠ SI-SNRè¨ˆç®—
- **v1.2**: æ·»åŠ é€²åº¦è¿½è¹¤å’ŒéŒ¯èª¤è™•ç†
- **v1.3**: å„ªåŒ–æ–‡ä»¶ç®¡ç†å’Œæ¸…ç†æ©Ÿåˆ¶
